<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="This function needs an installation of Nix. with_nix() has two effects
to run code in isolated and reproducible environments.
Evaluate a function in R or a shell command via the nix-shell
environment (Nix expression for custom software libraries; involving pinned
versions of R and R packages via Nixpkgs)
If no error, return the result object of expr in with_nix() into the
current R session.

"><title>Evaluate function in R or shell command via nix-shell environment — with_nix • rix</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Evaluate function in R or shell command via nix-shell environment — with_nix"><meta property="og:description" content="This function needs an installation of Nix. with_nix() has two effects
to run code in isolated and reproducible environments.
Evaluate a function in R or a shell command via the nix-shell
environment (Nix expression for custom software libraries; involving pinned
versions of R and R packages via Nixpkgs)
If no error, return the result object of expr in with_nix() into the
current R session.

"><meta property="og:image" content="/logo.png"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">rix</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5.1.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/building-an-environment-for-literate-programming.html">Building an environment for literate programming</a>
    <a class="dropdown-item" href="../articles/building-reproducible-development-environments-with-rix.html">Building reproducible development environments with rix</a>
    <a class="dropdown-item" href="../articles/handling-packages-with-remote-dependencies.html">Handling packages with remote dependencies</a>
    <a class="dropdown-item" href="../articles/interactive-use.html">Interactive use</a>
    <a class="dropdown-item" href="../articles/reproducible-analytical-pipelines-with-nix.html">Reproducible Analytical Pipelines with Nix</a>
    <a class="dropdown-item" href="../articles/running-r-or-shell-code-in-nix-from-r.html">Running R or shell code in Nix from R</a>
    <a class="dropdown-item" href="../articles/save-the-nix-package-versions-data.html">Save the Nix Package Versions data</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"></ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Evaluate function in R or shell command via <code>nix-shell</code> environment</h1>
      
      <div class="d-none name"><code>with_nix.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This function needs an installation of Nix. <code>with_nix()</code> has two effects
to run code in isolated and reproducible environments.</p><ol><li><p>Evaluate a function in R or a shell command via the <code>nix-shell</code>
environment (Nix expression for custom software libraries; involving pinned
versions of R and R packages via Nixpkgs)</p></li>
<li><p>If no error, return the result object of <code>expr</code> in <code>with_nix()</code> into the
current R session.</p></li>
</ol></div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">with_nix</span><span class="op">(</span></span>
<span>  <span class="va">expr</span>,</span>
<span>  program <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"R"</span>, <span class="st">"shell"</span><span class="op">)</span>,</span>
<span>  exec_mode <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"blocking"</span>, <span class="st">"non-blocking"</span><span class="op">)</span>,</span>
<span>  project_path <span class="op">=</span> <span class="st">"."</span>,</span>
<span>  nix_file <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  message_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"simple"</span>, <span class="st">"verbose"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>expr</dt>
<dd><p>Single R function or call, or character vector of length one with
shell command and possibly options (flags) of the command to be invoked.
For <code>program = R</code>, you can both use a named or an anonymous function.
The function provided in <code>expr</code> should not evaluate when you pass arguments,
hence you need to wrap your function call like
<code>function() your_fun(arg_a = "a", arg_b = "b")</code>, to avoid evaluation and make
sure <code>expr</code> is a function (see details and examples).</p></dd>


<dt>program</dt>
<dd><p>String stating where to evaluate the expression. Either <code>"R"</code>,
the default, or <code>"shell"</code>. <code>where = "R"</code> will evaluate the expression via
<code>RScript</code> and <code>where = "shell"</code> will run the system command in <code>nix-shell</code>.</p></dd>


<dt>exec_mode</dt>
<dd><p>Either <code>"blocking"</code> (default) or <code>"non-blocking</code>. This
will either block the R session while <code>expr</code> is running in a <code>nix-shell</code>
environment, oor running it in the background ("non-blocking"). While
<code>program = R</code> will yield identical results for foreground and background
evaluation (R object), <code>program = "shell"</code> will return list of exit status,
standard output and standard error of the system command and as text in
blocking mode.</p></dd>


<dt>project_path</dt>
<dd><p>Path to the folder where the <code>default.nix</code> file resides.
The default is <code>"."</code>, which is the working directory in the current R
session. This approach also useful when you have different subfolders
with separate software environments defined in different <code>default.nix</code> files.
If you prefer to run code in custom <code>.nix</code> files in the same directory
using <code>with_nix()</code>, you can use the <code>nix_file</code> argument to specify paths
to <code>.nix</code> files.</p></dd>


<dt>nix_file</dt>
<dd><p>Path to <code>.nix</code> file that contains the expressions defining
the Nix software environment in which you want to run <code>expr</code>. See
<code>project_path</code> argument as an alternative way to specify the environment.</p></dd>


<dt>message_type</dt>
<dd><p>String how detailed output is. Currently, there is
either <code>"simple"</code> (default) or <code>"verbose"</code>, which shows the script that runs
via <code>nix-shell</code>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<ul><li><p>if <code>program = "R"</code>, R object returned by function given in <code>expr</code>
when evaluated via the R environment in <code>nix-shell</code> defined by Nix
expression.</p></li>
<li><p>if <code>program = "shell"</code>, list with the following elements:</p><ul><li><p><code>status</code>: exit code</p></li>
<li><p><code>stdout</code>: character vector with standard output</p></li>
<li><p><code>stderr</code>: character vector with standard error
of <code>expr</code> command sent to a command line interface provided by a Nix package.</p></li>
</ul></li>
</ul></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p><code>with_nix()</code> gives you the power of evaluating a main function <code>expr</code>
and its function call stack that are defined in the current R session
in an encapsulated nix-R session defined by Nix expression (<code>default.nix</code>),
which is located in at a distinct project path (<code>project_path</code>).</p>
<p><code>with_nix()</code> is very convenient because it gives direct code feedback in
read-eval-print-loop style, which gives a direct interface to the very
reproducible infrastructure-as-code approach offered by Nix and Nixpkgs. You
don't need extra efforts such as setting up DevOps tooling like Docker and
domain specific tools like renv to control complex software environments in
R and any other language. It is for example useful for the following
purposes.</p><ol><li><p>test compatibility of custom R code and software/package dependencies in
development and production environments</p></li>
<li><p>directly stream outputs (returned objects), messages and errors from any
command line tool offered in Nixpkgs into an R session.</p></li>
<li><p>Test if evolving R packages change their behavior for given unchanged
R code, and whether they give identical results or not.</p></li>
</ol><p><code>with_nix()</code> can evaluate both R code from a nix-R session within
another nix-R session, and also from a host R session (i.e., on macOS or
Linux) within a specific nix-R session. This feature is useful for testing
the reproducibility and compatibility of given code across different software
environments. If testing of different sets of environments is necessary, you
can easily do so by providing Nix expressions in custom <code>.nix</code> or
<code>default.nix</code> files in different subfolders of the project.</p>
<p>To do its job, <code>with_nix()</code> heavily relies on patterns that manipulate
language expressions (aka computing on the language) offered in base R as
well as the codetools package by Luke Tierney.</p>
<p>Some of the key steps that are done behind the scene:</p><ol><li><p>recursively find, classify, and export global objects (globals) in the
call stack of <code>expr</code> as well as propagate R package environments found.</p></li>
<li><p>Serialize (save to disk) and deserialize (read from disk) dependent
data structures as <code>.Rds</code> with necessary function arguments provided,
any relevant globals in the call stack, packages, and <code>expr</code> outputs
returned in a temporary directory.</p></li>
<li><p>Use pure <code>nix-shell</code> environments to execute a R code script
reconstructed catching expressions with quoting; it is launched by commands
like this via <code>{sys}</code> by Jeroen Ooms:
<code>nix-shell --pure --run "Rscript --vanilla"</code>.</p></li>
</ol></div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Bruno Rodrigues, Philipp Baumann.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer></div>

  

  

  </body></html>

