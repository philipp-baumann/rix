<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="rix">
<title>z - Advanced topic: Building an environment for literate programming • rix</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="z - Advanced topic: Building an environment for literate programming">
<meta property="og:description" content="rix">
<meta property="og:image" content="https://b-rodrigues.github.io/rix/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">rix</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/a-getting-started.html">a - Getting started</a>
    <a class="dropdown-item" href="../articles/b1-setting-up-and-using-rix-on-linux-and-windows.html">b1 - Setting up and using rix on Linux and Windows</a>
    <a class="dropdown-item" href="../articles/b2-setting-up-and-using-rix-on-macos.html">b2 - Setting up and using rix on macOS</a>
    <a class="dropdown-item" href="../articles/c-using-rix-to-build-project-specific-environments.html">c - Using rix to build project specific environments</a>
    <a class="dropdown-item" href="../articles/d1-installing-r-packages-in-a-nix-environment.html">d1 - Installing R packages in a Nix environment</a>
    <a class="dropdown-item" href="../articles/d2-installing-system-tools-and-texlive-packages-in-a-nix-environment.html">d2 - Installing system tools and TexLive packages in a Nix environment</a>
    <a class="dropdown-item" href="../articles/e-interactive-use.html">e - Interactive use</a>
    <a class="dropdown-item" href="../articles/z-advanced-topic-building-an-environment-for-literate-programming.html">z - Advanced topic: Building an environment for literate programming</a>
    <a class="dropdown-item" href="../articles/z-advanced-topic-handling-packages-with-remote-dependencies.html">z - Advanced topic: Handling packages with remote dependencies</a>
    <a class="dropdown-item" href="../articles/z-advanced-topic-reproducible-analytical-pipelines-with-nix.html">z - Advanced topic: Reproducible Analytical Pipelines with Nix</a>
    <a class="dropdown-item" href="../articles/z-advanced-topic-running-r-or-shell-code-in-nix-from-r.html">z - Advanced topic: Running R or Shell Code in Nix from R</a>
    <a class="dropdown-item" href="../articles/z-developers-vignette-save-the-nix-package-versions-data.html">z - Developers Vignette: Save the Nix Package Versions data</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/b-rodrigues/rix/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>z - Advanced topic: Building an environment for literate programming</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/b-rodrigues/rix/blob/HEAD/vignettes/z-advanced-topic-building-an-environment-for-literate-programming.Rmd" class="external-link"><code>vignettes/z-advanced-topic-building-an-environment-for-literate-programming.Rmd</code></a></small>
      <div class="d-none name"><code>z-advanced-topic-building-an-environment-for-literate-programming.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://b-rodrigues.github.io/rix/">rix</a></span><span class="op">)</span></span></code></pre></div>
<!-- WARNING - This vignette is generated by {fusen} from dev/z-literate_programming.Rmd: do not edit by hand -->
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette will walk you through setting up a development
environment with <a href="https://b-rodrigues.github.io/rix/">rix</a> that can be used to compile Quarto
documents into PDFs. We are going to use the <a href="https://github.com/quarto-journals/jss" class="external-link">Quarto template for the
JSS</a> to illustrate the process. The first section will show a simple
way of achieving this, which will also be ideal for interactive
development (writing the doc). The second section will discuss a way to
build the document in a completely reproducible manner once it’s
done.</p>
</div>
<div class="section level2">
<h2 id="starting-with-the-basics-simple-but-not-entirely-reproducible">Starting with the basics (simple but not entirely reproducible)<a class="anchor" aria-label="anchor" href="#starting-with-the-basics-simple-but-not-entirely-reproducible"></a>
</h2>
<p>This approach will not be the most optimal, but it will be the
simplest. We will start by building a development environment with all
our dependencies, and we can then use it to compile our document
interactively. But this approach is not quite reproducible and requires
manual actions. In the next section we will show you to build a 100%
reproducible document in a single command.</p>
<p>Since we need both the <a href="https://github.com/quarto-dev/quarto-r" class="external-link">quarto</a> R package as well as the
<code>quarto</code> engine, we add both of them to the
<code>r_pkgs</code> and <code>system_pkgs</code> of arguments of
<a href="https://b-rodrigues.github.io/rix/">rix</a>. Because we want to compile a PDF, we also need to
have <code>texlive</code> installed, as well as some LaTeX packages. For
this, we use the <code>tex_pkgs</code> argument:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">path_default_nix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/rix.html">rix</a></span><span class="op">(</span>r_ver <span class="op">=</span> <span class="st">"4.3.1"</span>,</span>
<span>    r_pkgs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"quarto"</span><span class="op">)</span>,</span>
<span>    system_pkgs <span class="op">=</span> <span class="st">"quarto"</span>,</span>
<span>    tex_pkgs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"amsmath"</span><span class="op">)</span>,</span>
<span>    ide <span class="op">=</span> <span class="st">"other"</span>,</span>
<span>    shell_hook <span class="op">=</span> <span class="st">""</span>,</span>
<span>    project_path <span class="op">=</span> <span class="va">path_default_nix</span>,</span>
<span>    overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    print <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; # This file was generated by the {rix} R package v0.6.0 on 2024-02-07</span></span>
<span><span class="co">#&gt; # with following call:</span></span>
<span><span class="co">#&gt; # &gt;rix(r_ver = "976fa3369d722e76f37c77493d99829540d43845",</span></span>
<span><span class="co">#&gt; #  &gt; r_pkgs = c("quarto"),</span></span>
<span><span class="co">#&gt; #  &gt; system_pkgs = "quarto",</span></span>
<span><span class="co">#&gt; #  &gt; tex_pkgs = c("amsmath"),</span></span>
<span><span class="co">#&gt; #  &gt; ide = "other",</span></span>
<span><span class="co">#&gt; #  &gt; project_path = path_default_nix,</span></span>
<span><span class="co">#&gt; #  &gt; overwrite = TRUE,</span></span>
<span><span class="co">#&gt; #  &gt; print = TRUE,</span></span>
<span><span class="co">#&gt; #  &gt; shell_hook = "")</span></span>
<span><span class="co">#&gt; # It uses nixpkgs' revision 976fa3369d722e76f37c77493d99829540d43845 for reproducibility purposes</span></span>
<span><span class="co">#&gt; # which will install R version 4.3.1</span></span>
<span><span class="co">#&gt; # Report any issues to https://github.com/b-rodrigues/rix</span></span>
<span><span class="co">#&gt; let</span></span>
<span><span class="co">#&gt;  pkgs = import (fetchTarball "https://github.com/NixOS/nixpkgs/archive/976fa3369d722e76f37c77493d99829540d43845.tar.gz") {};</span></span>
<span><span class="co">#&gt;  rpkgs = builtins.attrValues {</span></span>
<span><span class="co">#&gt;   inherit (pkgs.rPackages) quarto;</span></span>
<span><span class="co">#&gt; };</span></span>
<span><span class="co">#&gt;   tex = (pkgs.texlive.combine {</span></span>
<span><span class="co">#&gt;   inherit (pkgs.texlive) scheme-small amsmath;</span></span>
<span><span class="co">#&gt; });</span></span>
<span><span class="co">#&gt;  system_packages = builtins.attrValues {</span></span>
<span><span class="co">#&gt;   inherit (pkgs) R glibcLocales nix quarto;</span></span>
<span><span class="co">#&gt; };</span></span>
<span><span class="co">#&gt;   in</span></span>
<span><span class="co">#&gt;   pkgs.mkShell {</span></span>
<span><span class="co">#&gt;     LOCALE_ARCHIVE = if pkgs.system == "x86_64-linux" then  "${pkgs.glibcLocales}/lib/locale/locale-archive" else "";</span></span>
<span><span class="co">#&gt;     LANG = "en_US.UTF-8";</span></span>
<span><span class="co">#&gt;     LC_ALL = "en_US.UTF-8";</span></span>
<span><span class="co">#&gt;     LC_TIME = "en_US.UTF-8";</span></span>
<span><span class="co">#&gt;     LC_MONETARY = "en_US.UTF-8";</span></span>
<span><span class="co">#&gt;     LC_PAPER = "en_US.UTF-8";</span></span>
<span><span class="co">#&gt;     LC_MEASUREMENT = "en_US.UTF-8";</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     buildInputs = [  rpkgs tex system_packages  ];</span></span>
<span><span class="co">#&gt;       </span></span>
<span><span class="co">#&gt;   }</span></span></code></pre></div>
<p>(Save these lines into a script called <code>build_env.R</code> for
instance, and run the script into a new folder made for this
project.)</p>
<p>By default, <a href="https://b-rodrigues.github.io/rix/">rix</a> will install the “small” version of
the <code>texlive</code> distribution available on Nix. To see which
<code>texlive</code> packages get installed with this small version, you
can click <a href="https://search.nixos.org/packages?channel=unstable&amp;show=texlive.combined.scheme-small&amp;from=0&amp;size=50&amp;sort=relevance&amp;type=packages&amp;query=scheme-small" class="external-link">here</a>.
We start by adding the <code>amsmath</code> package then build the
environment using:</p>
<pre><code><span><span class="va">nix</span><span class="op">-</span><span class="va">build</span></span></code></pre>
<p>from a terminal, or <code><a href="../reference/nix_build.html">nix_build()</a></code> from an interactive R
session.</p>
<p>Then, drop into the Nix shell with <code>nix-shell</code>, and run
<code>quarto add quarto-journals/jss</code>. This will install the
template linked above. Then, in the folder that contains
<code>build_env.R</code>, the generated <code>default.nix</code> and
<code>result</code> download the following files from <a href="https://github.com/quarto-journals/jss/" class="external-link">here</a>:</p>
<ul>
<li>article-visualization.pdf</li>
<li>bibliography.bib</li>
<li>template.qmd</li>
</ul>
<p>and try to compile <code>template.qmd</code> by running:</p>
<pre><code>quarto render template.qmd --to jss-pdf</code></pre>
<p>You should get the following error message:</p>
<pre><code>Quitting from lines 99-101 [unnamed-chunk-1] (template.qmd)
Error in `find.package()`:
! there is no package called 'MASS'
Backtrace:
 1. utils::data("quine", package = "MASS")
 2. base::find.package(package, lib.loc, verbose = verbose)
Execution halted
</code></pre>
<p>So there’s an R chunk in <code>template.qmd</code> that uses the
<a href="http://www.stats.ox.ac.uk/pub/MASS4/" class="external-link">MASS</a> package. Change <code>build_env.R</code> to generate
a new <code>default.nix</code> file that will now add
<a href="http://www.stats.ox.ac.uk/pub/MASS4/" class="external-link">MASS</a> to the environment when built:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rix.html">rix</a></span><span class="op">(</span>r_ver <span class="op">=</span> <span class="st">"4.3.1"</span>,</span>
<span>    r_pkgs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"quarto"</span>, <span class="st">"MASS"</span><span class="op">)</span>,</span>
<span>    system_pkgs <span class="op">=</span> <span class="st">"quarto"</span>,</span>
<span>    tex_pkgs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"amsmath"</span><span class="op">)</span>,</span>
<span>    ide <span class="op">=</span> <span class="st">"other"</span>,</span>
<span>    shell_hook <span class="op">=</span> <span class="st">""</span>,</span>
<span>    project_path <span class="op">=</span> <span class="va">path_default_nix</span>,</span>
<span>    overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    print <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; # This file was generated by the {rix} R package v0.6.0 on 2024-02-07</span></span>
<span><span class="co">#&gt; # with following call:</span></span>
<span><span class="co">#&gt; # &gt;rix(r_ver = "976fa3369d722e76f37c77493d99829540d43845",</span></span>
<span><span class="co">#&gt; #  &gt; r_pkgs = c("quarto",</span></span>
<span><span class="co">#&gt; #  &gt; "MASS"),</span></span>
<span><span class="co">#&gt; #  &gt; system_pkgs = "quarto",</span></span>
<span><span class="co">#&gt; #  &gt; tex_pkgs = c("amsmath"),</span></span>
<span><span class="co">#&gt; #  &gt; ide = "other",</span></span>
<span><span class="co">#&gt; #  &gt; project_path = path_default_nix,</span></span>
<span><span class="co">#&gt; #  &gt; overwrite = TRUE,</span></span>
<span><span class="co">#&gt; #  &gt; print = TRUE,</span></span>
<span><span class="co">#&gt; #  &gt; shell_hook = "")</span></span>
<span><span class="co">#&gt; # It uses nixpkgs' revision 976fa3369d722e76f37c77493d99829540d43845 for reproducibility purposes</span></span>
<span><span class="co">#&gt; # which will install R version 4.3.1</span></span>
<span><span class="co">#&gt; # Report any issues to https://github.com/b-rodrigues/rix</span></span>
<span><span class="co">#&gt; let</span></span>
<span><span class="co">#&gt;  pkgs = import (fetchTarball "https://github.com/NixOS/nixpkgs/archive/976fa3369d722e76f37c77493d99829540d43845.tar.gz") {};</span></span>
<span><span class="co">#&gt;  rpkgs = builtins.attrValues {</span></span>
<span><span class="co">#&gt;   inherit (pkgs.rPackages) quarto MASS;</span></span>
<span><span class="co">#&gt; };</span></span>
<span><span class="co">#&gt;   tex = (pkgs.texlive.combine {</span></span>
<span><span class="co">#&gt;   inherit (pkgs.texlive) scheme-small amsmath;</span></span>
<span><span class="co">#&gt; });</span></span>
<span><span class="co">#&gt;  system_packages = builtins.attrValues {</span></span>
<span><span class="co">#&gt;   inherit (pkgs) R glibcLocales nix quarto;</span></span>
<span><span class="co">#&gt; };</span></span>
<span><span class="co">#&gt;   in</span></span>
<span><span class="co">#&gt;   pkgs.mkShell {</span></span>
<span><span class="co">#&gt;     LOCALE_ARCHIVE = if pkgs.system == "x86_64-linux" then  "${pkgs.glibcLocales}/lib/locale/locale-archive" else "";</span></span>
<span><span class="co">#&gt;     LANG = "en_US.UTF-8";</span></span>
<span><span class="co">#&gt;     LC_ALL = "en_US.UTF-8";</span></span>
<span><span class="co">#&gt;     LC_TIME = "en_US.UTF-8";</span></span>
<span><span class="co">#&gt;     LC_MONETARY = "en_US.UTF-8";</span></span>
<span><span class="co">#&gt;     LC_PAPER = "en_US.UTF-8";</span></span>
<span><span class="co">#&gt;     LC_MEASUREMENT = "en_US.UTF-8";</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     buildInputs = [  rpkgs tex system_packages  ];</span></span>
<span><span class="co">#&gt;       </span></span>
<span><span class="co">#&gt;   }</span></span></code></pre></div>
<p>Trying to compile the document results now in another error
message:</p>
<pre><code>compilation failed- no matching packages
LaTeX Error: File `orcidlink.sty' not found</code></pre>
<p>This means that the LaTeX <code>orcidlink</code> package is missing,
and we can solve the problem by adding <code>"orcidlink"</code> to the
list of <code>tex_pkgs</code>. Rebuild the environment and try again to
compile the template. Trying again yields a new error:</p>
<pre><code>compilation failed- no matching packages
LaTeX Error: File `tcolorbox.sty' not found.</code></pre>
<p>Just as before, add the <code>tcolorbox</code> package to the list of
<code>tex_pkgs</code>. You will need to do this several times for some
other packages. There is unfortunately no easier way to list the
dependencies and requirements of a LaTeX document.</p>
<p>This is what the final script to build the environment looks
like:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rix.html">rix</a></span><span class="op">(</span>r_ver <span class="op">=</span> <span class="st">"4.3.1"</span>,</span>
<span>    r_pkgs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"quarto"</span>, <span class="st">"MASS"</span><span class="op">)</span>,</span>
<span>    system_pkgs <span class="op">=</span> <span class="st">"quarto"</span>,</span>
<span>    tex_pkgs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"amsmath"</span>,</span>
<span>      <span class="st">"environ"</span>,</span>
<span>      <span class="st">"fontawesome5"</span>,</span>
<span>      <span class="st">"orcidlink"</span>,</span>
<span>      <span class="st">"pdfcol"</span>,</span>
<span>      <span class="st">"tcolorbox"</span>,</span>
<span>      <span class="st">"tikzfill"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    ide <span class="op">=</span> <span class="st">"other"</span>,</span>
<span>    shell_hook <span class="op">=</span> <span class="st">""</span>,</span>
<span>    project_path <span class="op">=</span> <span class="va">path_default_nix</span>,</span>
<span>    overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    print <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; # This file was generated by the {rix} R package v0.6.0 on 2024-02-07</span></span>
<span><span class="co">#&gt; # with following call:</span></span>
<span><span class="co">#&gt; # &gt;rix(r_ver = "976fa3369d722e76f37c77493d99829540d43845",</span></span>
<span><span class="co">#&gt; #  &gt; r_pkgs = c("quarto",</span></span>
<span><span class="co">#&gt; #  &gt; "MASS"),</span></span>
<span><span class="co">#&gt; #  &gt; system_pkgs = "quarto",</span></span>
<span><span class="co">#&gt; #  &gt; tex_pkgs = c("amsmath",</span></span>
<span><span class="co">#&gt; #  &gt; "environ",</span></span>
<span><span class="co">#&gt; #  &gt; "fontawesome5",</span></span>
<span><span class="co">#&gt; #  &gt; "orcidlink",</span></span>
<span><span class="co">#&gt; #  &gt; "pdfcol",</span></span>
<span><span class="co">#&gt; #  &gt; "tcolorbox",</span></span>
<span><span class="co">#&gt; #  &gt; "tikzfill"),</span></span>
<span><span class="co">#&gt; #  &gt; ide = "other",</span></span>
<span><span class="co">#&gt; #  &gt; project_path = path_default_nix,</span></span>
<span><span class="co">#&gt; #  &gt; overwrite = TRUE,</span></span>
<span><span class="co">#&gt; #  &gt; print = TRUE,</span></span>
<span><span class="co">#&gt; #  &gt; shell_hook = "")</span></span>
<span><span class="co">#&gt; # It uses nixpkgs' revision 976fa3369d722e76f37c77493d99829540d43845 for reproducibility purposes</span></span>
<span><span class="co">#&gt; # which will install R version 4.3.1</span></span>
<span><span class="co">#&gt; # Report any issues to https://github.com/b-rodrigues/rix</span></span>
<span><span class="co">#&gt; let</span></span>
<span><span class="co">#&gt;  pkgs = import (fetchTarball "https://github.com/NixOS/nixpkgs/archive/976fa3369d722e76f37c77493d99829540d43845.tar.gz") {};</span></span>
<span><span class="co">#&gt;  rpkgs = builtins.attrValues {</span></span>
<span><span class="co">#&gt;   inherit (pkgs.rPackages) quarto MASS;</span></span>
<span><span class="co">#&gt; };</span></span>
<span><span class="co">#&gt;   tex = (pkgs.texlive.combine {</span></span>
<span><span class="co">#&gt;   inherit (pkgs.texlive) scheme-small amsmath environ fontawesome5 orcidlink pdfcol tcolorbox tikzfill;</span></span>
<span><span class="co">#&gt; });</span></span>
<span><span class="co">#&gt;  system_packages = builtins.attrValues {</span></span>
<span><span class="co">#&gt;   inherit (pkgs) R glibcLocales nix quarto;</span></span>
<span><span class="co">#&gt; };</span></span>
<span><span class="co">#&gt;   in</span></span>
<span><span class="co">#&gt;   pkgs.mkShell {</span></span>
<span><span class="co">#&gt;     LOCALE_ARCHIVE = if pkgs.system == "x86_64-linux" then  "${pkgs.glibcLocales}/lib/locale/locale-archive" else "";</span></span>
<span><span class="co">#&gt;     LANG = "en_US.UTF-8";</span></span>
<span><span class="co">#&gt;     LC_ALL = "en_US.UTF-8";</span></span>
<span><span class="co">#&gt;     LC_TIME = "en_US.UTF-8";</span></span>
<span><span class="co">#&gt;     LC_MONETARY = "en_US.UTF-8";</span></span>
<span><span class="co">#&gt;     LC_PAPER = "en_US.UTF-8";</span></span>
<span><span class="co">#&gt;     LC_MEASUREMENT = "en_US.UTF-8";</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     buildInputs = [  rpkgs tex system_packages  ];</span></span>
<span><span class="co">#&gt;       </span></span>
<span><span class="co">#&gt;   }</span></span></code></pre></div>
<p>The template will now compile with this environment. To look for a
LaTeX package, you can use the <a href="https://ctan.org/pkg/orcidlink?lang=en" class="external-link">search engine on
CTAN</a>.</p>
<p>As stated in the beginning of this section, this approach is not the
most optimal, but it has its merits, especially if you’re still working
on the document. Once the environment is set up, you can simply work on
the doc and compile it as needed using <code>quarto render</code>. In
the next section, we will explain how to build a 100% reproducible
document.</p>
</div>
<div class="section level2">
<h2 id="reproducible-literate-programming">100% reproducible literate programming<a class="anchor" aria-label="anchor" href="#reproducible-literate-programming"></a>
</h2>
<p>Let’s not forget that Nix is not just a package manager, but also a
programming language. The <code>default.nix</code> files that
<a href="https://b-rodrigues.github.io/rix/">rix</a> generates are written in this language, which was
made entirely for the purpose of building software. If you are not a
developer, you may not realise it but the process of compiling a Quarto
or LaTeX document is very similar to the process of building any piece
of software. So we can use Nix to compile a document in a completely
reproducible environment.</p>
<p>First, let’s fork the repo that contains the Quarto template we need.
We will fork <a href="https://github.com/quarto-journals/jss" class="external-link">this
repo</a>. This repo contains the <code>template.qmd</code> file that we
can change (which is why we fork it, in practice we would replace this
<code>template.qmd</code> by our own, finished, source <code>.qmd</code>
file). Now we need to change our <code>default.nix</code>:</p>
<pre><code>let
 pkgs = import (fetchTarball "https://github.com/NixOS/nixpkgs/archive/976fa3369d722e76f37c77493d99829540d43845.tar.gz") {};
 rpkgs = builtins.attrValues {
   inherit (pkgs.rPackages) quarto MASS;
 };
 tex = (pkgs.texlive.combine {
   inherit (pkgs.texlive) scheme-small amsmath environ fontawesome5 orcidlink pdfcol tcolorbox tikzfill;
 });
 system_packages = builtins.attrValues {
   inherit (pkgs) R quarto;
 };
 in
 pkgs.mkShell {
   buildInputs = [  rpkgs tex system_packages  ];
 }</code></pre>
<p>to the following:</p>
<pre><code>let
 pkgs = import (fetchTarball "https://github.com/NixOS/nixpkgs/archive/976fa3369d722e76f37c77493d99829540d43845.tar.gz") {};
 rpkgs = builtins.attrValues {
  inherit (pkgs.rPackages) quarto MASS;
 };
 tex = (pkgs.texlive.combine {
  inherit (pkgs.texlive) scheme-small amsmath environ fontawesome5 orcidlink pdfcol tcolorbox tikzfill;
 });
 system_packages = builtins.attrValues {
  inherit (pkgs) R quarto;
 };
 in
 pkgs.stdenv.mkDerivation {
   name = "my-paper";
   src = pkgs.fetchgit {
       url = "https://github.com/b-rodrigues/my_paper/";
       branchName = "main";
       rev = "715e9f007d104c23763cebaf03782b8e80cb5445";
       sha256 = "sha256-e8Xg7nJookKoIfiJVTGoJkvCuFNTT83YZ6SK3GT2T8g=";
     };
   buildInputs = [  rpkgs tex system_packages  ];
   buildPhase =
     ''
     # Deno needs to add stuff to $HOME/.cache
     # so we give it a home to do this
     mkdir home
     export HOME=$PWD/home
     quarto add --no-prompt $src
     quarto render $PWD/template.qmd --to jss-pdf
     '';
   installPhase =
     ''
     mkdir -p $out
     cp template.pdf $out/
     '';
 }</code></pre>
<p>So we changed the second part of the file, we’re not building a shell
anymore using <code>mkShell</code>, but a <em>derivation</em>.
<em>Derivation</em> is Nix jargon for package, or software. So what is
our derivation? First, we clone the repo we forked just before (I forked
the repository and called it <code>my_paper</code>):</p>
<pre><code>pkgs.stdenv.mkDerivation {
  name = "my-paper";
  src = pkgs.fetchgit {
      url = "https://github.com/b-rodrigues/my_paper/";
      branchName = "main";
      rev = "715e9f007d104c23763cebaf03782b8e80cb5445";
      sha256 = "sha256-e8Xg7nJookKoIfiJVTGoJkvCuFNTT83YZ6SK3GT2T8g=";
    };</code></pre>
<p>This repo contains our quarto template, and because we’re using a
specific commit, we will always use exactly this release of the template
for our document. This is in contrast to before where we used
<code>quarto add quarto-journals/jss</code> to install the template.
Doing this interactively makes our project not reproducible because if
we compile our Quarto doc today, we would be using the template as it is
today, but if we compile the document in 6 months, then we would be
using the template as it would be in 6 months (we should say that it is
possible to install specific releases of Quarto templates using
following notation: <code>quarto add quarto-journals/jss@v0.9.2</code>
so this problem can be mitigated).</p>
<p>The next part of the file contains following lines:</p>
<pre><code>buildInputs = [  rpkgs tex system_packages  ];
buildPhase =
  ''
  # Deno needs to add stuff to $HOME/.cache
  # so we give it a home to do this
  mkdir home
  export HOME=$PWD/home
  quarto add --no-prompt $src
  quarto render $PWD/template.qmd --to jss-pdf
  '';</code></pre>
<p>The <code>buildInputs</code> are the same as before. What’s new is
the <code>buildPhase</code>. This is actually the part in which the
document gets compiled. The first step is to create a <code>home</code>
directory. This is because Quarto needs to save the template we want to
use in <code>/home/.cache/deno</code>. If you’re using
<code>quarto</code> interactively, that’s not an issue, since your home
directory will be used. But with Nix, things are different, so we need
to create an empty directory and specify this as the home. This is what
these two lines do:</p>
<pre><code>mkdir home
export HOME=$PWD/home</code></pre>
<p>(<code>$PWD</code> —Print Working Directory— is a shell variable
referring to the current working directory.)</p>
<p>Now, we need to install the template that we cloned from Github. For
this we can use <code>quarto add</code> just as before, but instead of
installing it directly from Github, we install it from the repository
that we cloned. We also add the <code>--no-prompt</code> flag so that
the template gets installed without asking us for confirmation. This is
similar to how when building a Docker image, we don’t want any
interactive prompt to show up, or else the process will get stuck.
<code>$src</code> refers to the path of our downloaded Github
repository. Finally we can compile the document:</p>
<pre><code>quarto render $PWD/template.qmd --to jss-pdf</code></pre>
<p>This will compile the <code>template.qmd</code> (our finished paper).
Finally, there’s the <code>installPhase</code>:</p>
<pre><code>installPhase =
  ''
  mkdir -p $out
  cp template.pdf $out/
  '';</code></pre>
<p><code>$out</code> is a shell variable defined inside the build
environment and refers to the path, so we can use it to create a
directory that will contain our output (the compiled PDF file). So we
use <code>mkdir -p</code> to recursively create all the directory
structure, and then copy the compiled document to <code>$out/</code>. We
can now build our document by running <code><a href="../reference/nix_build.html">nix_build()</a></code>. Now, you
may be confused by the fact that you won’t see the PDF in your working
directory. But remember that software built by Nix will always be stored
in the Nix store, so our PDF is also in the store, since this is what we
built. To find it, run:</p>
<pre><code>readlink result</code></pre>
<p>which will show the path to the PDF. You could use this to open the
PDF in your PDF viewer application (on Linux at least):</p>
<pre><code>xdg-open $(readlink result)/template.pdf</code></pre>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>This vignette showed two approaches, both have their merits: the
first approach that is more interactive is useful while writing the
document. You get access to a shell and can work on the document and
compile it quickly. The second approach is more useful once the document
is ready and you want to have a way of quickly rebuilding it for
reproducibility purposes.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Bruno Rodrigues, Philipp Baumann.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
